<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KlondikeTextualController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">easygo</a> &gt; <a href="index.source.html" class="el_package">klondike.controller</a> &gt; <span class="el_source">KlondikeTextualController.java</span></div><h1>KlondikeTextualController.java</h1><pre class="source lang-java linenums">package klondike.controller;

import java.io.IOException;
import java.util.List;
import java.util.Scanner;
import klondike.model.hw02.Card;
import klondike.model.hw02.KlondikeModel;
import klondike.view.KlondikeTextualView;

/**
 * A textual controller for a game of Klondike Solitaire.
 * This controller reads user input from a Readable source,
 * writes game output to an  Appendable, and interacts with a
 * KlondikeModel to play the game. It follows a command-based input format
 * allowing the user to move cards, discard draws, or quit the game
 */
public class KlondikeTextualController implements KlondikeController {
  private final Readable rd;
  private final Appendable ap;

  /**
   * Constructs a KlondikeTextualController that uses
   * the given Readable and Appendable for user input and output.
   *
   * @param rd the readable input source
   * @param ap the appendable output destination
   */
<span class="nc" id="L28">  public KlondikeTextualController(Readable rd, Appendable ap) {</span>
<span class="nc bnc" id="L29" title="All 4 branches missed.">    if (rd == null || ap == null) {</span>
<span class="nc" id="L30">      throw new IllegalArgumentException(&quot;Null arguments not allowed.&quot;);</span>
    }
<span class="nc" id="L32">    this.rd = rd;</span>
<span class="nc" id="L33">    this.ap = ap;</span>
<span class="nc" id="L34">  }</span>


  @Override
  public &lt;C extends Card&gt; void playGame(KlondikeModel&lt;C&gt; model, List&lt;C&gt; deck, boolean shuffle,
                                        int numPiles, int numDraw) {
<span class="nc bnc" id="L40" title="All 2 branches missed.">    if (model == null) {</span>
<span class="nc" id="L41">      throw new IllegalArgumentException(&quot;Null model&quot;);</span>
    }
<span class="nc" id="L43">    Scanner scan = new Scanner(rd);</span>
<span class="nc" id="L44">    KlondikeTextualView view = new KlondikeTextualView(model, ap);</span>
    try {
      try {
<span class="nc" id="L47">        model.startGame(deck, shuffle, numPiles, numDraw);</span>
<span class="nc" id="L48">      } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L49">        throw new IllegalStateException(&quot;Invalid game parameters&quot;, e);</span>
<span class="nc" id="L50">      }</span>
<span class="nc" id="L51">      renderState(view, model);</span>

<span class="nc bnc" id="L53" title="All 2 branches missed.">      while (!model.isGameOver()) {</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (!scan.hasNext()) {</span>
<span class="nc" id="L55">          break;</span>
        }
<span class="nc" id="L57">        String cmd = scan.next();</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (cmd.equalsIgnoreCase(&quot;q&quot;)) {</span>
<span class="nc" id="L59">          quitGame(model, view);</span>
<span class="nc" id="L60">          return;</span>
        }
        try {
<span class="nc" id="L63">          boolean moveMade = processCommand(cmd, scan, model, view);</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">          if (moveMade) {</span>
<span class="nc" id="L65">            renderState(view, model);</span>
          }
<span class="nc" id="L67">        } catch (IllegalStateException e) {</span>
<span class="nc bnc" id="L68" title="All 4 branches missed.">          if (e.getMessage() != null &amp;&amp; e.getMessage().equals(&quot;User quit&quot;)) {</span>
<span class="nc" id="L69">            return;</span>
          }
<span class="nc bnc" id="L71" title="All 4 branches missed.">          if (e.getMessage() != null &amp;&amp; e.getMessage().equals(&quot;no input&quot;)) {</span>
<span class="nc" id="L72">            throw e;</span>
          }
<span class="nc" id="L74">          ap.append(&quot;Invalid move. Play again&quot;);</span>
<span class="nc bnc" id="L75" title="All 4 branches missed.">          if (e.getMessage() != null &amp;&amp; !e.getMessage().isEmpty()) {</span>
<span class="nc" id="L76">            ap.append(&quot; &quot;).append(e.getMessage());</span>
          }
<span class="nc" id="L78">          ap.append(&quot;\n&quot;);</span>
<span class="nc" id="L79">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L80">          ap.append(&quot;Invalid move. Play again&quot;);</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">          if (e.getMessage() != null &amp;&amp; !e.getMessage().isEmpty()) {</span>
<span class="nc" id="L82">            ap.append(&quot; &quot;).append(e.getMessage());</span>
          }
<span class="nc" id="L84">          ap.append(&quot;\n&quot;);</span>
<span class="nc" id="L85">        }</span>
<span class="nc" id="L86">      }</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">      if (model.isGameOver()) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (model.getScore() == deck.size()) {</span>
<span class="nc" id="L89">          ap.append(&quot;You win!\n&quot;);</span>
        } else {
<span class="nc" id="L91">          ap.append(&quot;Game over. Score: &quot;).append(String.valueOf(model.getScore())).append(&quot;\n&quot;);</span>
        }
      }

<span class="nc" id="L95">    } catch (IOException e) {</span>
<span class="nc" id="L96">      throw new IllegalStateException(&quot;Transmission failed&quot;);</span>
<span class="nc" id="L97">    }</span>

<span class="nc" id="L99">  }</span>

  /**
   * Helps render the board and keep score together.
   *
   * @param view the textual view for rendering the game
   * @param model the Klondike Model representing the current game state
   * @param &lt;C&gt; the type of Card used by the model
   * @throws IOException IOException if this fails
   */
  private &lt;C extends Card&gt; void renderState(KlondikeTextualView view, KlondikeModel&lt;C&gt; model)
      throws IOException {
<span class="nc" id="L111">    view.render();</span>
<span class="nc" id="L112">    ap.append(&quot;Score: &quot;).append(String.valueOf(model.getScore())).append(&quot;\n&quot;);</span>
<span class="nc" id="L113">  }</span>

  /**
   * Handles user quitting the game by outputting the final game state and score.
   *
   * @param model the Klondike Model representing the current game state
   * @param &lt;C&gt; the type of Card used by the model
   * @throws IOException if writing output fails
   */
  private &lt;C extends Card&gt; void quitGame(KlondikeModel&lt;C&gt; model,
                                         KlondikeTextualView view) throws IOException {
<span class="nc" id="L124">    ap.append(&quot;Game quit!\nState of game when quit:\n&quot;);</span>
<span class="nc" id="L125">    view.render();</span>
<span class="nc" id="L126">    ap.append(&quot;Score: &quot;).append(String.valueOf(model.getScore())).append(&quot;\n&quot;);</span>
<span class="nc" id="L127">  }</span>
  /**
   * Processes a single command entered by the user, reading additional arguments
   * as needed and applying the corresponding action on the model.
   *
   * @param cmd   the initial command string entered by the user
   * @param scan  the scanner reading subsequent input values
   * @param m     the model to apply actions on
   * @throws IOException if writing output fails
   */

  private &lt;C extends Card&gt; boolean processCommand(String cmd, Scanner scan,
                                                  KlondikeModel&lt;C&gt; m, KlondikeTextualView view)
      throws IOException {
    try {
<span class="nc bnc" id="L142" title="All 6 branches missed.">      switch (cmd) {</span>
        case &quot;mpp&quot; -&gt; {
<span class="nc" id="L144">          int src = nextInt(scan, m, view);</span>
<span class="nc" id="L145">          int num = nextInt(scan, m, view);</span>
<span class="nc" id="L146">          int dest = nextInt(scan, m, view);</span>
<span class="nc" id="L147">          m.movePile(src - 1, num, dest - 1);</span>
<span class="nc" id="L148">        }</span>
        case &quot;md&quot; -&gt; {
<span class="nc" id="L150">          int pile = nextInt(scan, m, view);</span>
<span class="nc" id="L151">          m.moveDraw(pile - 1);</span>
<span class="nc" id="L152">        }</span>
        case &quot;mpf&quot; -&gt; {
<span class="nc" id="L154">          int src = nextInt(scan, m, view);</span>
<span class="nc" id="L155">          int fnd = nextInt(scan, m, view);</span>
<span class="nc" id="L156">          m.moveToFoundation(src - 1, fnd - 1);</span>
<span class="nc" id="L157">        }</span>
        case &quot;mdf&quot; -&gt; {
<span class="nc" id="L159">          int fnd = nextInt(scan, m, view);</span>
<span class="nc" id="L160">          m.moveDrawToFoundation(fnd - 1);</span>
<span class="nc" id="L161">        }</span>
<span class="nc" id="L162">        case &quot;dd&quot; -&gt; m.discardDraw();</span>
        default -&gt; {
<span class="nc" id="L164">          ap.append(&quot;Invalid move. Play again. Unknown command\n&quot;);</span>
<span class="nc" id="L165">          return false;</span>
        }
      }
<span class="nc" id="L168">      return true;</span>
<span class="nc" id="L169">    } catch (IllegalStateException e) {</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">      if (e.getMessage() != null</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">          &amp;&amp; (e.getMessage().equals(&quot;User quit&quot;) || e.getMessage().equals(&quot;no input&quot;))) {</span>
<span class="nc" id="L172">        throw e;</span>
      }
<span class="nc" id="L174">      ap.append(&quot;Invalid move. Play again.&quot;);</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">      if (e.getMessage() != null &amp;&amp; !e.getMessage().isEmpty()) {</span>
<span class="nc" id="L176">        ap.append(&quot; &quot;).append(e.getMessage());</span>
      }
<span class="nc" id="L178">      ap.append(&quot;\n&quot;);</span>
<span class="nc" id="L179">      return false;</span>
<span class="nc" id="L180">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L181">      ap.append(&quot;Invalid move. Play again.&quot;);</span>
<span class="nc bnc" id="L182" title="All 4 branches missed.">      if (e.getMessage() != null &amp;&amp; !e.getMessage().isEmpty()) {</span>
<span class="nc" id="L183">        ap.append(&quot; &quot;).append(e.getMessage());</span>
      }
<span class="nc" id="L185">      ap.append(&quot;\n&quot;);</span>
<span class="nc" id="L186">      return false;</span>
    }
  }
  /**
   * Reads the next integer input from the user, retrying as needed until a valid
   * integer is entered or a quit command is detected.
   *
   * @param s the scanner used to read user input
   * @return the next valid integer entered by the user
   * @throws IllegalStateException if the user quits or input is exhausted
   */

  private int nextInt(Scanner s, KlondikeModel&lt;?&gt; model, KlondikeTextualView view)
      throws IOException {
<span class="nc bnc" id="L200" title="All 2 branches missed.">    while (s.hasNext()) {</span>
<span class="nc" id="L201">      String n = s.next();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">      if (n.equalsIgnoreCase(&quot;q&quot;)) {</span>
<span class="nc" id="L203">        quitGame(model, view);</span>
<span class="nc" id="L204">        throw new IllegalStateException(&quot;User quit&quot;);</span>
      }
      try {
<span class="nc" id="L207">        return Integer.parseInt(n);</span>
<span class="nc" id="L208">      } catch (NumberFormatException e) {</span>
        // Ignore invalid input and continue scanning for the next token
      }
<span class="nc" id="L211">    }</span>
<span class="nc" id="L212">    throw new IllegalStateException(&quot;no input&quot;);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>